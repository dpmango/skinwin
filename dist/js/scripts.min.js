(function(){var t,i={}.hasOwnProperty;t=window,document,t.CnvRoulette=function(){function t(t){this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.objects=[],this.patterns={},this.P={background:"images/roulette-bg.png",centerX:this.canvas.width/2,centerY:this.canvas.height/2,picture:{width:54,height:54},chip:{width:90,height:82,amount:15},outlineRadius:32,speed:20,slowdown_step:3,minSpeed:4}}return t.prototype.init=function(t){var s,h,e,n,r,c,o,a;if(e=t.length,this.P.chip.amount>e)for(r=n=o=e,a=this.P.chip.amount;o<=a?n<a:n>a;r=o<=a?++n:--n)s=r%e,t.push(JSON.parse(JSON.stringify(t[s])));for(h in t)i.call(t,h)&&(c=t[h],this.objects[h]=this.createPlayerObj(c,h));this._l=this.objects.length,this._d=0,this._a=0,this.winner_id=null,this.addPattern(this.P.background),this.status="init"},t.prototype.start=function(){if("init"===this.status||"stop"===this.status)return this.winner_id=null,this._a=0,this.P.speed=20,this.status="spin",this.draw()},t.prototype.stop=function(t,i){var s,h,e,n;for(this.afterStop=i,this.status="slowdown",h=Math.floor(this.P.speed/this.P.slowdown_step),s=e=0,n=this.objects.length;0<=n?e<n:e>n;s=0<=n?++e:--e)this.objects[s].id===t&&null===this.winner_id&&(this.winner_id=s);return this.slowDownTimer=setInterval(function(t){return function(){if(h-- >0&&(t.P.speed-=t.P.slowdown_step,t.P.speed<t.P.minSpeed))return t.P.speed=t.P.minSpeed}}(this),1e3)},t.prototype.addPattern=function(t){var i;if(void 0===this.patterns[t])return this.patterns[t]=!1,i=new Image,i.onload=function(s){return function(){return s.patterns[t]=i,s.draw(!1)}}(this),i.src=t},t.prototype.createPlayerObj=function(t,i){return this.addPattern(t.picture),this.addPattern(t.big_picture),this.addPattern(t.gray_picture),{id:t.id,num:i,color:t.color,picture:t.picture,big_picture:t.big_picture,gray_picture:t.gray_picture,x:(i-1)*this.P.chip.width}},t.prototype.toGray=function(){var t,i,s,h;for(h=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),i=h.data,s=0;s<i.length;)t=.34*i[s]+.5*i[s+1]+.16*i[s+2],i[s]=t,i[s+1]=t,i[s+2]=t,s+=4;this.ctx.putImageData(h,0,0)},t.prototype.drawPlayer=function(t,i,s){var h;if(null==s&&(s=0),h=s?"#cccccc":i.color,this.ctx.beginPath(),this.ctx.arc(t+this.P.chip.width/2,this.P.centerY,this.P.outlineRadius,0,2*Math.PI),this.ctx.strokeStyle=h,this.ctx.lineWidth=2,this.ctx.shadowBlur=s?8:0,this.ctx.shadowColor=h,this.ctx.stroke(),this.ctx.shadowBlur=0,s){if(this.patterns[i.gray_picture])return this.ctx.drawImage(this.patterns[i.gray_picture],t+(this.P.chip.width-this.P.picture.width)/2,(this.canvas.height-this.P.picture.height)/2,54,54)}else if(this.patterns[i.picture])return this.ctx.drawImage(this.patterns[i.picture],t+(this.P.chip.width-this.P.picture.width)/2,(this.canvas.height-this.P.picture.height)/2,54,54)},t.prototype.drawWinner=function(){if(this.ctx.beginPath(),this.ctx.arc(this.P.centerX,this.P.centerY,56,0,2*Math.PI),this.ctx.strokeStyle=this.objects[this.winner_id].color,this.ctx.lineWidth=3,this.ctx.shadowBlur=3,this.ctx.shadowColor=this.objects[this.winner_id].color,this.ctx.stroke(),this.ctx.shadowBlur=0,this.patterns[this.objects[this.winner_id].big_picture])return this.ctx.drawImage(this.patterns[this.objects[this.winner_id].big_picture],this.P.centerX-48,this.P.centerY-48,96,96)},t.prototype.drawPointer=function(t){var i;return null==t&&(t=.1),i=5,t>1&&(t=1),this.ctx.fillStyle="rgba(238, 23, 23, "+t+")",this.ctx.beginPath(),this.ctx.moveTo(this.P.centerX-20,i),this.ctx.lineTo(this.P.centerX+20,i),this.ctx.lineTo(this.P.centerX,34+i),this.ctx.closePath(),this.ctx.fill(),this.ctx.beginPath(),this.ctx.moveTo(this.P.centerX-20,this.canvas.height-i),this.ctx.lineTo(this.P.centerX+20,this.canvas.height-i),this.ctx.lineTo(this.P.centerX,this.canvas.height-34-i),this.ctx.closePath(),this.ctx.fill()},t.prototype.drawBg=function(){if(this.patterns[this.P.background])return this.ctx.shadowBlur=0,this.ctx.drawImage(this.patterns[this.P.background],-170,14,1425,93)},t.prototype.draw=function(t){var i,s,h,e,n,r,c,o;if(null==t&&(t=!0),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawBg(),"init"!==this.status&&"stop"!==this.status||this.toGray(),("spin"===this.status||"slowdown"===this.status)&&(this._d+=this.P.speed,this._d>=this.P.chip.width))for(this._d=0,this.objects[this.objects.length-1].x=this.objects[0].x,s=h=0,r=this.objects.length-1;0<=r?h<r:h>r;s=0<=r?++h:--h)this.objects[s].x=this.objects[s+1].x;for("slowdown"===this.status&&(this.P.speed<=this.P.minSpeed&&this.objects[this.winner_id].x+1.5*this.P.chip.width+this._d>=this.P.centerX&&this.objects[this.winner_id].x+this.P.chip.width/2+this._d<=this.P.centerX&&(this.P.speed=1,clearInterval(this.slowDownTimer)),1===this.P.speed&&this.objects[this.winner_id].x+this.P.chip.width/2+this._d>=this.P.centerX&&(this.status="stop","function"==typeof this.afterStop&&this.afterStop())),s=e=0,c=this.objects.length;0<=c?e<c:e>c;s=0<=c?++e:--e)this.drawPlayer(this.objects[s].x+this._d,this.objects[s],1);if("spin"===this.status||"slowdown"===this.status){for(this.ctx.clearRect(this.P.centerX-this.P.chip.width/2,0,this.P.chip.width,this.canvas.height),this.ctx.globalCompositeOperation="destination-over",this.drawBg(),s=n=0,o=this.objects.length;0<=o?n<o:n>o;s=0<=o?++n:--n)this.drawPlayer(this.objects[s].x+this._d,this.objects[s],0);this.ctx.globalCompositeOperation="source-over"}if("slowdown"!==this.status&&"stop"!==this.status||this.drawPointer(this._a+=.05),"stop"===this.status&&(this.toGray(),this.drawPointer(this._a+=.05),this.drawWinner()),("slowdown"===this.status||"spin"===this.status||"winner_showing"===this.status)&&t)return i=function(t){return function(){return t.draw()}}(this),requestAnimationFrame(i)},t}()}).call(this);